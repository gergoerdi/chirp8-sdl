use chirp8::peripherals::*;
use chirp8::prelude::*;

use std::fs::File;
use std::io::Read;

pub fn setup<P>(file_name: &std::path::PathBuf, io: &mut P)
    where P: Peripherals
{
    let font_rom = [
        0xF0, 0x90, 0x90, 0x90, 0xF0, 0x00, 0x00, 0x00,
        0x20, 0x60, 0x20, 0x20, 0x70, 0x00, 0x00, 0x00,
        0xF0, 0x10, 0xF0, 0x80, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x10, 0xF0, 0x10, 0xF0, 0x00, 0x00, 0x00,
        0x90, 0x90, 0xF0, 0x10, 0x10, 0x00, 0x00, 0x00,
        0xF0, 0x80, 0xF0, 0x10, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x80, 0xF0, 0x90, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x10, 0x20, 0x40, 0x40, 0x00, 0x00, 0x00,
        0xF0, 0x90, 0xF0, 0x90, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x90, 0xF0, 0x10, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x90, 0xF0, 0x90, 0x90, 0x00, 0x00, 0x00,
        0xE0, 0x90, 0xE0, 0x90, 0xE0, 0x00, 0x00, 0x00,
        0xF0, 0x80, 0x80, 0x80, 0xF0, 0x00, 0x00, 0x00,
        0xE0, 0x90, 0x90, 0x90, 0xE0, 0x00, 0x00, 0x00,
        0xF0, 0x80, 0xF0, 0x80, 0xF0, 0x00, 0x00, 0x00,
        0xF0, 0x80, 0xF0, 0x80, 0x80, 0x00, 0x00, 0x00
    ];

    for (addr, b) in font_rom.iter().enumerate() {
        io.write_ram(addr as Addr, *b);
    }

    let mut file = File::open(file_name).unwrap();
    let mut buf = [0; 4 * 2 << 10];
    let mut ptr = 0x0200;
    'load: loop {
        let read_bytes = file.read(&mut buf[..]).unwrap();

        if read_bytes == 0 {
            break 'load;
        }

        for offset in 0..read_bytes {
            io.write_ram(ptr + offset as Addr, buf[offset]);
        }
        ptr += read_bytes as Addr;
    }
}
